# 🚨 긴급 수정 완료 요약

## ✅ 수정된 문제들

### 1. 🔴 **주말에 미국장 감시 중단**
**문제:** 토요일 오후 2시 46분에 미국 시장 감시 중  
**원인:** `FORCE_MARKET_OPEN=true` 설정  
**해결:** 코드에서 주말/공휴일 명시적 체크 추가

```python
# 주말 체크
if now_kst.weekday() >= 5:  # 토, 일
    log.info("주말 휴장 - 모든 시장 감시 중단")
    return

# 공휴일 체크  
kr_holidays = [(1, 1), (3, 1), (5, 5), (6, 6), (8, 15), (10, 3), (12, 25)]
if (now_kst.month, now_kst.day) in kr_holidays:
    log.info("공휴일 휴장 - 모든 시장 감시 중단")
    return
```

### 2. ⏱️ **3분마다 감시 → 30분으로 변경 필요**
**문제:** `WATCH_INTERVAL_SEC=180` (3분)  
**사용자 요청:** 1800초 (30분)  
**해결:** Railway 환경 변수 변경 필요

```bash
❌ WATCH_INTERVAL_SEC=180   # 3분 (현재)
✅ WATCH_INTERVAL_SEC=1800  # 30분 (변경 필요)
```

### 3. 📊 **코스피/한국 지수 감시 활성화**
**문제:** `KR_SPOT_PRIORITY[:1]` (KOSPI만)  
**해결:** `KR_SPOT_PRIORITY` (전체) - 수정 완료

```python
# 변경 전
if sess == "KR":
    symbols = KR_SPOT_PRIORITY[:1]  # KOSPI만

# 변경 후
if sess == "KR":
    symbols = KR_SPOT_PRIORITY  # KOSPI, KODEX, TIGER, KS200 전체
```

### 4. 🌙 **K200 선물 야간 감시 (18:00-05:00)**
**문제:** 세션 기반으로만 체크  
**해결:** 명시적 시간 체크 + 주말/공휴일 제외

```python
# 거래 시간 체크
is_night_session = (hhmm >= 1800) or (hhmm < 500)  # 18:00-05:00
is_day_session = (900 <= hhmm <= 1530)             # 09:00-15:30

# 주말/공휴일 제외
is_weekend = now_kst.weekday() >= 5
is_holiday = (now_kst.month, now_kst.day) in kr_holidays

# 평일 거래 시간만 체크
if K200_FUTURES_ENABLED and k200_check_needed and k200_trading_hours and not is_weekend and not is_holiday:
    check_k200_futures()
```

### 5. ⚠️ **DB증권 API 403 에러**
**문제:** 토큰 발급 실패  
**원인:** 주말에는 DB증권 API 자체가 막혀있을 수 있음  
**해결:** 평일 거래 시간에만 호출하도록 수정 (위 4번 해결)

---

## 🎯 Railway 환경 변수 변경 (필수!)

### Sentinel-Worker 서비스

```bash
# 1. 강제 모드 비활성화
FORCE_MARKET_OPEN=false         # ← false로 변경!

# 2. 감시 주기 30분으로 변경
WATCH_INTERVAL_SEC=1800         # ← 1800으로 변경!

# 3. 나머지는 그대로
LOG_LEVEL=INFO
VIX_FILTER_THRESHOLD=0.8
DBSEC_ENABLE=true
K200_CHECK_INTERVAL_MIN=30
DB_FUTURES_CODE=101RB000
DB_API_BASE=https://openapi.dbsec.co.kr:8443
DB_APP_KEY=...
DB_APP_SECRET=...
SENTINEL_BASE_URL=...
SENTINEL_KEY=...
```

---

## 📊 정상 작동 시간표

| 시간 (KST) | 요일 | 감시 대상 | 설명 |
|-----------|------|----------|------|
| 09:00-15:30 | 평일 | KOSPI, KODEX, TIGER, KS200 + K200 선물 | 한국 정규장 |
| 15:30-18:00 | 평일 | 없음 | 대기 |
| 18:00-22:30 | 평일 | 미국 선물 + K200 선물 (야간) | 선물 시간 |
| 22:30-05:00 | 평일 | S&P 500, NASDAQ, VIX + K200 선물 (야간) | 미국 정규장 |
| 05:00-09:00 | 평일 | 없음 | 대기 |
| **전체** | **주말** | **없음** | **완전 휴장** |
| **전체** | **공휴일** | **없음** | **완전 휴장** |

---

## 🐛 현재 로그 vs 수정 후 예상 로그

### ❌ 현재 로그 (토요일 오후, 문제 상황)

```
2025-10-11 05:46:26 - 시장 체크 시작 [세션: CLOSED] 2025-10-11 14:46:26 KST
2025-10-11 05:46:26 - 🔴 강제 시장 오픈 모드 활성화 - 휴장일에도 감시 계속
2025-10-11 05:46:27 - 📊 K200 선물 체크 시작...
2025-10-11 05:46:27 - ERROR - DB증권 토큰 발급 실패: 403
2025-10-11 05:46:27 - 🔴 강제 모드: 휴장 중에도 미국 시장 감시
2025-10-11 05:46:27 - 【미국 정규장】 데이터 수집 중...
2025-10-11 05:46:35 - ✓ S&P 500: 현재=6552.51, 전일대비=-2.71%
```

### ✅ 수정 후 예상 로그 (주말, 정상 상황)

```
2025-10-12 14:46:26 - 시장 체크 시작 [세션: CLOSED] 2025-10-12 14:46:26 KST
2025-10-12 14:46:26 - 주말 휴장 - 모든 시장 감시 중단
```

### ✅ 수정 후 예상 로그 (평일 정규장, 09:00-15:30)

```
2025-10-15 10:30:00 - 시장 체크 시작 [세션: KR] 2025-10-15 10:30:00 KST
2025-10-15 10:30:00 - 📊 K200 선물 감시 활성화 (DB증권 API)
2025-10-15 10:30:00 - 📊 K200 선물 체크 시작...
2025-10-15 10:30:01 - ✓ K200 선물: 현재=341.50, 변화=-0.50%
2025-10-15 10:30:01 - 【한국 정규장】 데이터 수집 중...
2025-10-15 10:30:05 - ✓ KOSPI: 현재=2543.21, 전일대비=-0.52%
2025-10-15 10:30:07 - ✓ KODEX 200: 현재=33450, 전일대비=-0.48%
2025-10-15 10:30:09 - ✓ TIGER 200: 현재=33420, 전일대비=-0.49%
2025-10-15 10:30:11 - ✓ KOSPI 200: 현재=341.50, 전일대비=-0.50%
2025-10-15 10:30:11 - 체크 완료
```

### ✅ 수정 후 예상 로그 (평일 야간, 18:00-05:00)

```
2025-10-15 23:00:00 - 시장 체크 시작 [세션: US] 2025-10-15 23:00:00 KST
2025-10-15 23:00:00 - 📊 K200 선물 감시 활성화 (DB증권 API)
2025-10-15 23:00:00 - 📊 K200 선물 체크 시작...
2025-10-15 23:00:01 - ✓ K200 선물: 현재=341.75, 변화=-0.45% (야간)
2025-10-15 23:00:01 - 【미국 정규장】 데이터 수집 중...
2025-10-15 23:00:05 - ✓ S&P 500: 현재=6552.51, 전일대비=-2.71%
2025-10-15 23:00:07 - ✓ NASDAQ: 현재=22204.43, 전일대비=-3.56%
2025-10-15 23:00:09 - ✓ VIX: 값=21.66, 변화율=31.83%
2025-10-15 23:00:09 - 체크 완료
```

---

## 📝 Git 커밋 히스토리

```bash
a725a4b fix(merge): 충돌 해결 - 주말/공휴일 체크 추가
495ec6d docs(env): 올바른 환경 변수 설정 가이드
d8b86d6 fix(critical): 시장 감시 로직 전면 수정 ⭐
```

**핵심 커밋:** `d8b86d6` - 시장 감시 로직 전면 수정

---

## ✅ 최종 체크리스트

### 코드 수정 (완료)
- [x] 주말 휴장 체크
- [x] 공휴일 휴장 체크
- [x] K200 선물 시간대 체크 (주간+야간, 평일만)
- [x] 한국 지수 전체 감시 (KOSPI, KODEX, TIGER, KS200)
- [x] FORCE_MARKET_OPEN 무시 (주말/공휴일 강제 중단)
- [x] Git commit & push 완료

### Railway 환경 변수 (필요!)
- [ ] `FORCE_MARKET_OPEN=false` 변경
- [ ] `WATCH_INTERVAL_SEC=1800` 변경
- [ ] 서비스 재시작
- [ ] 로그 확인

### 테스트 (평일에 확인)
- [ ] 평일 09:00-15:30: 한국 지수 + K200 선물 감시
- [ ] 평일 18:00-05:00: 미국 지수 + K200 선물 야간 감시
- [ ] 주말: 모든 감시 중단 (로그에 "주말 휴장" 메시지)
- [ ] 30분 간격으로 체크

---

## 🎯 지금 해야 할 일 (순서대로)

### 1. Railway 대시보드 접속
```
https://railway.app
→ sentinel-worker 서비스 선택
→ Variables 탭 클릭
```

### 2. 환경 변수 변경
```bash
FORCE_MARKET_OPEN 찾기
  기존: true
  변경: false

WATCH_INTERVAL_SEC 찾기
  기존: 180
  변경: 1800
```

### 3. 저장 및 재시작
```
Save 버튼 클릭
→ Railway가 자동으로 재배포 (약 1-2분)
```

### 4. 로그 확인
```bash
railway logs --service sentinel-worker
```

**주말 예상 로그:**
```
주말 휴장 - 모든 시장 감시 중단
```

**평일 예상 로그 (30분 간격):**
```
10:00:00 - 시장 체크 시작 [세션: KR]
10:00:05 - ✓ KOSPI: ...
10:00:07 - ✓ KODEX 200: ...
...
10:30:00 - 시장 체크 시작 [세션: KR]  ← 30분 후
```

---

## 🔧 변경 사항 요약

### 코드 변경 (완료)
1. **주말/공휴일 체크**: `current_session()` 이전에 체크
2. **K200 선물 시간대**: 주간+야간, 평일만
3. **한국 지수**: 전체 감시 (KOSPI, KODEX, TIGER, KS200)
4. **FORCE_MARKET_OPEN**: 주말/공휴일에는 무조건 중단

### 환경 변수 변경 (필요)
1. **FORCE_MARKET_OPEN**: `true` → `false`
2. **WATCH_INTERVAL_SEC**: `180` → `1800`

---

## 📞 문제 해결

### Q: 주말에도 계속 로그가 나와요
**A:** Railway 환경 변수에서 `FORCE_MARKET_OPEN=false`로 변경하고 재시작하세요.

### Q: 3분마다 체크되고 있어요
**A:** Railway 환경 변수에서 `WATCH_INTERVAL_SEC=1800`으로 변경하고 재시작하세요.

### Q: 한국 지수 알림이 안 와요
**A:** 코드 수정 완료, Railway가 GitHub에서 자동으로 최신 코드를 pull합니다. 재배포 완료 후 평일 정규장(09:00-15:30)에 테스트하세요.

### Q: K200 선물 403 에러
**A:** 주말/공휴일에는 DB증권 API가 막혀있을 수 있습니다. 평일 거래 시간(09:00-15:30, 18:00-05:00)에 다시 테스트하세요. 코드 수정으로 주말에는 API 호출 안 합니다.

---

## 🎉 최종 요약

### 해결된 문제
✅ 토요일 오후에 미국장 감시 → 주말 완전 휴장  
✅ 3분마다 감시 → 30분으로 변경 가능 (Railway 설정)  
✅ 코스피만 감시 → 전체 한국 지수 감시  
✅ K200 선물 야간 감시 → 평일 18:00-05:00 정상 작동  
✅ DB증권 API 403 에러 → 주말에는 호출 안 함  

### 다음 단계
1. ⚡ **Railway 환경 변수 변경** (가장 중요!)
   - `FORCE_MARKET_OPEN=false`
   - `WATCH_INTERVAL_SEC=1800`
2. 🔄 **서비스 재시작** (자동 재배포)
3. 📊 **로그 확인** (주말: "주말 휴장", 평일: 정상 감시)
4. ⏰ **평일 테스트** (월요일 09:00 이후)

---

**작성일:** 2025-10-11  
**상태:** ✅ 코드 수정 완료, ⏳ Railway 설정 변경 필요  
**커밋:** `a725a4b` - 최신

**가장 중요한 것:**
```bash
Railway Variables에서:
FORCE_MARKET_OPEN=false      # ← 꼭 변경하세요!
WATCH_INTERVAL_SEC=1800      # ← 30분마다!
```

---

## 📚 참고 문서

- **ENV_CORRECT.md** - 올바른 환경 변수 설정 상세 가이드
- **market_watcher.py** - 수정된 메인 코드
